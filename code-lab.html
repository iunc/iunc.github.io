<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code lab</title>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  background:#0b0f14;
  color:white;
  font-family:monospace;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
  
.topbar{
  height:50px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 15px;
  background:#111827;
  border-bottom:1px solid #1f2937;
}

.topbar button{
  background:#0f172a;
  border:1px solid #1f2937;
  color:#38bdf8;
  padding:6px 12px;
  border-radius:10px;
  font-size:13px;
}

.tabs{
  display:flex;
  height:40px;
  background:#0f172a;
}

.tabs button{
  flex:1;
  border:none;
  background:none;
  color:#94a3b8;
  font-weight:bold;
}

.tabs button.active{
  color:#38bdf8;
  border-bottom:2px solid #38bdf8;
}

.editor{
  height:38%;
  background:#0b0f14;
}

textarea{
  width:100%;
  height:100%;
  border:none;
  resize:none;
  padding:14px;
  background:#0b0f14;
  color:#22c55e;
  font-size:14px;
  font-family: "Fira Code", monospace;
  line-height:1.5;
  outline:none;
}
  
.preview{
  flex:1;
  display:flex;
  flex-direction:column;
  border-top:1px solid #1f2937;
}

iframe{
  flex:1;
  border:none;
  background:white;
}

.console{
  height:80px;
  background:#05080c;
  color:#22c55e;
  padding:10px;
  overflow:auto;
  font-size:12px;
  border-top:1px solid #1f2937;
  font-family:monospace;
}
  .title{
  cursor:pointer;
  font-weight:bold;
  font-size: 15px;
  letter-spacing:1px;
  color:#38bdf8;
}

.title:active{
  opacity:0.6;
}
  
.control-bar{
  height:45px;
  display:flex;
  align-items:center;
  gap:6px;
  padding:0 8px;
  background:#0f172a;
  border-top:1px solid #1f2937;
  border-bottom:1px solid #1f2937;

  overflow-x:auto;
  scrollbar-width:none;
}

.control-bar::-webkit-scrollbar{
  display:none;
}

.control-bar button{
  display:flex;
  align-items:center;
  gap:6px;

  background:#111827;
  border:1px solid #1f2937;
  color:#38bdf8;

  padding:6px 10px;
  border-radius:10px;
  font-size:13px;
  white-space:nowrap;
  cursor:pointer;
  transition:0.15s;
}

.control-bar button:hover{
  background:#1f2937;
}

.control-bar button:active{
  transform:scale(0.95);
}
body.hidden{
  display:none;
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}

.modal-box{
  background:#0f172a;
  padding:20px;
  width:85%;
  max-width:320px;
  border-radius:14px;
  border:1px solid #1f2937;
  box-shadow:0 0 20px rgba(56,189,248,0.3);
  text-align:center;
}

.modal-box h3{
  margin:0 0 10px;
  color:#38bdf8;
}

.modal-box p{
  font-size:14px;
  color:#94a3b8;
}

.modal-actions{
  margin-top:15px;
  display:flex;
  justify-content:space-between;
}

.modal-actions button{
  flex:1;
  margin:0 5px;
  padding:8px;
  border:none;
  border-radius:8px;
  background:#1f2937;
  color:#38bdf8;
  font-weight:bold;
}

.modal-actions button.danger{
  background:#0ea5e9;
  color:black;
}
</style>
</head>

<body class="hidden">

<div class="topbar">
  <button onclick="location.href='dashboard.html'" style="font-weight: bold"> ‚óÄ Back</button>
  <div class="title" >CODE LAB</div>
  <button style="font-weight: bold" onclick="alert(' C√≥ g√¨ ƒë√¢u m√† ƒëi hihi')">Go ‚ñ∂</button>
</div>

<div class="tabs">
  <button id="btn-html" class="active" onclick="switchTab('html')">HTML</button>
  <button id="btn-css" onclick="switchTab('css')">CSS</button>
  <button id="btn-js" onclick="switchTab('js')">JS</button>
</div>

<div class="editor">
  <textarea id="html" autocapitalize="off"
  autocomplete="off"
  autocorrect="off"
  spellcheck="false"></textarea>
  <textarea id="css" style="display:none" autocapitalize="off"
  autocomplete="off"
  autocorrect="off"
  spellcheck="false"></textarea>
  <textarea id="js" style="display:none" autocapitalize="off"
  autocomplete="off"
  autocorrect="off"
  spellcheck="false"></textarea>
</div>

<div class="control-bar">
  <button onclick="taomoi()">üÜïNew</button>
  <button onclick="copyCode()">üìãCopy</button>
  <button onclick="runCode()">‚ñ∂Run</button>
  <button onclick="exportProject()">üì•Export</button>
  <button onclick="importProject()">üìÇImport</button>
  <input type="file" id="importFile" accept=".html" style="display:none">
  <button onclick="reloadPreview()">‚ü≥Reload</button>
</div>
  
<div class="preview">
  <iframe id="preview"></iframe>
  <div class="console" id="console"></div> 
</div>
<div id="modal" class="modal">
  <div class="modal-box">
    <h3>T·∫°o project m·ªõi?</h3>
    <p>Code hi·ªán t·∫°i s·∫Ω b·ªã xo√°.</p>
    <div class="modal-actions">
      <button onclick="closeModal()">Hu·ª∑</button>
      <button class="danger" onclick="confirmNew()">T·∫°o m·ªõi</button>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuBHbln6bqYn9SpwOC2eDke3JJ32nE7vs",
  authDomain: "iunc-login.firebaseapp.com",
  projectId: "iunc-login",
  storageBucket: "iunc-login.firebasestorage.app",
  messagingSenderId: "359473829379",
  appId: "1:359473829379:web:b1102278155f598e316036"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.replace("login.html");
  } else {
    document.body.classList.remove("hidden");
  }
});
</script>
  
<script>
let autoRun;

function switchTab(tab){
  ["html","css","js"].forEach(id=>{
    document.getElementById(id).style.display="none";
    document.getElementById("btn-"+id).classList.remove("active");
  });
  document.getElementById(tab).style.display="block";
  document.getElementById("btn-"+tab).classList.add("active");
}

function runCode(){
  const html = htmlEl.value;
  const css = cssEl.value;
  const js = jsEl.value;

  const output = `
  <html>
  <head><style>${css}</style></head>
  <body>
  ${html}
  <script>
  const log = (...a)=>parent.postMessage({type:'log',data:a.join(" ")},'*');
  console.log = log;
  try{ ${js} }catch(e){ log("Error: "+e.message) }
  <\/script>
  </body>
  </html>
  `;

  consoleBox.innerHTML="";
  preview.srcdoc = output;
}

window.addEventListener("message",(e)=>{
  if(e.data.type==="log"){
    consoleBox.innerHTML += e.data.data+"<br>";
    consoleBox.scrollTop = consoleBox.scrollHeight;
  }
});

const htmlEl = document.getElementById("html");
const cssEl = document.getElementById("css");
const jsEl = document.getElementById("js");
const preview = document.getElementById("preview");
const consoleBox = document.getElementById("console");

[htmlEl,cssEl,jsEl].forEach(el=>{
  el.addEventListener("input",()=>{
    clearTimeout(autoRun);
    autoRun=setTimeout(runCode,800);
  });
});

//G·ª£i √Ω code
const snippets = {
  html: {
    "!html": `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Document</title>
</head>
<body>
|
</body>
</html>`,
    "div.": `<div class="|"></div>`,
    "div#": `<div id="|"></div>`,
    "h1": `<h1>|</h1>`,
    "h2": `<h2>|</h2>`,
    "h3": `<h3>|</h3>`,
    "h4": `<h4>|</h4>`,
    "h5": `<h5>|</h5>`,
    "h6": `<h6>|</h6>`,
    "h1.": `<h1 class="|"></h1>`,
    "h2.": `<h2 class="|"></h2>`,
    "h3.": `<h3 class="|"></h3>`,
    "h4.": `<h4 class="|"></h4>`,
    "h5.": `<h5 class="|"></h5>`,
    "h6.": `<h6 class="|"></h6>`,
    "h1#": `<h1 id="|"></h1>`,
    "h2#": `<h2 id="|"></h2>`,
    "h3#": `<h3 id="|"></h3>`,
    "h4#": `<h4 id="|"></h4>`,
    "h5#": `<h5 id="|"></h5>`,
    "h6#": `<h6 id="|"></h6>`,
    "p": `<p>|</p>`,
    "div": `<div>|</div>`,
    "btn": `<button>|</button>`,
    "span": `<span>|</span>`,
    "span.": `<span class="|"></span>`,
    "span#": `<span id="|"></span>`,
  },

  css: {
    "flex": `display:flex;
justify-content:center;
align-items:center;|`,
    "center": `display:flex;
justify-content:center;
align-items:center;
height:100vh;|`,
    "fz": `font-size:|`,
    "fw": `font-weight:|`,
    "ff": `font-family:|`,
    "bg": `background:|`,
    "bgc": `background-color:|`,
    "bgr": `background-repeat:|`,
    "bgp": `background-position:|`,
    "bgs": `background-size:|`,
    "d": `display:|`,
    "di": `display:inline;|`,
    "db": `display:block;|`,
    "dib": `display:inline-block;|`,
    "df": `display:flex;|`,
    "dg": `display:grid;|`,
    "dn": `display:none;|`,
    "jc": `justify-content:|`,
    "jc-c": `justify-content:center;|`,
    "jc-fs": `justify-content:flex-start;|`,
    "jc-fe": `justify-content:flex-end;|`,
    "jc-sb": `justify-content:space-between;|`,
    "jc-sa": `justify-content:space-around;|`,
    "jc-se": `justify-content:space-evenly;|`,
    "ai": `align-items:|`,
    "ai-c": `align-items:center;|`,
    "ai-fs": `align-items:flex-start;|`,
    "ai-fe": `align-items:flex-end;|`,
    "ai-b": `align-items: baseline;|`,
    "ai-s": `align-items: stretch;|`,
    "p": `padding:|`,
    "pt": `padding-top:|`,
    "pb": `padding-bottom:|`,
    "pl": `padding-left:|`,
    "pr": `padding-right:|`,
    "bdrs": `border-radius:|`,
    "m": `margin:|`,
    "mt": `margin-top:|`,
    "mb": `margin-bottom:|`,
    "ml": `margin-left:|`,
    "mr": `margin-right:|`,
    "fd": `flex-direction:|`,
    "fd-r": `flex-direction:row;|`,
    "fd-c": `flex-direction:coloum;|`,
    "fd-rr": `flex-direction:row-reverse;|`,
    "fd-cr": `flex-direction:column-reverse;|`,
    "lts": `letter-spacing:|`,
    "bd": `border:|`,
    "bdt": `border-top:|`,
    "bdb": `border-bottom:|`,
    "bdl": `border-left:|`,
    "bdr": `border-right:|`,
    "bdc": `border-color:|`,
    "ts": `text-shadow:|`,
    "h": `height:|`,
    "w": `width:|`,
    "tac": `text-align:center;|`,
    "tar": `text-align:right;|`,
    "tal": `text-align:left;|`,
    "taj": `text-align:justify;|`,
    "fvn": `font-variant-numeric:|`,
  },

  js: {
    "log": `console.log(|);`,
    "func": `function myFunction|(){
}`,
  }
};
  
[htmlEl, cssEl, jsEl].forEach(el=>{
  el.addEventListener("input", function(event){
    if(event.inputType === "deleteContentBackward") return;
    const tab =
      el === htmlEl ? "html" :
      el === cssEl ? "css" : "js";
    const cursor = el.selectionStart;
    const textBefore = el.value.substring(0, cursor);
    // ===== AUTO PAIR =====
const lastChar = textBefore.slice(-1);
const autoPairs = {
  "{": "{|}",
  "(": "(|)",
  "[": "[|]",
  "\"": "\"|\"",
  "'": "'|'"
};
if(autoPairs[lastChar]){
  let snippet = autoPairs[lastChar];
  const before = textBefore.slice(0,-1);
  const after = el.value.substring(cursor);
  const cursorMarker = snippet.indexOf("|");
  snippet = snippet.replace("|","");
  el.value = before + snippet + after;
  el.selectionStart = el.selectionEnd =
    before.length + cursorMarker;
  return; // r·∫•t quan tr·ªçng
      }
    const match = textBefore.match(/(\S+)\s$/);
    if(!match) return;
    const lastWord = match[1];
    if(snippets[tab] && snippets[tab][lastWord]){
    let snippet = snippets[tab][lastWord];
    const before = textBefore.slice(0, -(lastWord.length + 1));
    const after = el.value.substring(cursor);
    const cursorMarker = snippet.indexOf("|");
    snippet = snippet.replace("|","");
    el.value = before + snippet + after;
    if(cursorMarker !== -1){
    const newPos = before.length + cursorMarker;
    el.selectionStart = el.selectionEnd = newPos;
  }
  runCode();
    }
  });
});

  
// New t·∫°o project m·ªõi
const modal = document.getElementById("modal");
function taomoi(){
  modal.style.display="flex";
}
function closeModal(){
  modal.style.display="none";
}
function confirmNew(){
  htmlEl.value="";
  cssEl.value="";
  jsEl.value="";
  consoleBox.innerHTML="";
  preview.srcdoc="";
  document.getElementById("importFile").value=""; 
  modal.style.display="none";
}
  
//Copy code
function copyCode(){
  const activeTab =
    htmlEl.style.display !== "none" ? htmlEl :
    cssEl.style.display !== "none" ? cssEl :
    jsEl;
  navigator.clipboard.writeText(activeTab.value);
}

//Export
function exportProject(){

  const fullCode = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Project</title>
<style>
${cssEl.value}
</style>
</head>
<body>
${htmlEl.value}

<script>
${jsEl.value}
<\/script>
</body>
</html>
`; 

  const blob = new Blob([fullCode], { type: "text/html" });

  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "iunc.html";
  a.click();

  URL.revokeObjectURL(url);
}

//Import
function importProject(){
  const input = document.getElementById("importFile");
  input.value = "";     // reset tr∆∞·ªõc khi m·ªü
  input.click();
}

document.getElementById("importFile").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = function(event){
    const content = event.target.result;

    // T√°ch CSS
    const cssMatch = content.match(/<style>([\s\S]*?)<\/style>/);
    const css = cssMatch ? cssMatch[1].trim() : "";

    // T√°ch JS
    const jsMatch = content.match(/<script>([\s\S]*?)<\/script>/);
    const js = jsMatch ? jsMatch[1].trim() : "";

    // T√°ch HTML (lo·∫°i b·ªè style + script)
    let html = content
      .replace(/<!DOCTYPE[\s\S]*?<body>/i, "")
      .replace(/<\/body>[\s\S]*/i, "")
      .replace(/<style>[\s\S]*?<\/style>/i, "")
      .replace(/<script>[\s\S]*?<\/script>/i, "")
      .trim();

    htmlEl.value = html;
    cssEl.value = css;
    jsEl.value = js;

    runCode();
    e.target.value = "";
  };

  reader.readAsText(file);
});
</script>

</body>
</html>
