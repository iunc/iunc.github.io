<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;padding:20px;background:#0f0f0f;color:white;font-family:sans-serif}
textarea,input,button{width:100%;padding:12px;margin-bottom:10px;border-radius:10px;border:none}
textarea,input{background:#262626;color:white}
button{background:#3b82f6;color:white;font-weight:bold}
.note{background:#1e293b;padding:15px;margin-top:10px;border-radius:12px}
small{color:#00ffcc}
.migrate{background:#f59e0b}
.logout{background:#444}
</style>
</head>
<body>

<h2>Ghi chú của bạn</h2>

<input type="text" id="search" placeholder="Tìm kiếm...">
<textarea id="content" placeholder="Nhập ghi chú..."></textarea>

<button id="saveBtn">Lưu Ghi Chú</button>
<button onclick="migrateOldNotes()" class="migrate">Migrate Note Cũ (Bấm 1 lần)</button>
<button onclick="logout()" class="logout">Đăng xuất</button>

<div id="notes"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  deleteDoc,
  doc,
  updateDoc,
  getDocs,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuBHbln6bqYn9SpwOC2eDke3JJ32nE7vs",
  authDomain: "iunc-login.firebaseapp.com",
  projectId: "iunc-login",
  storageBucket: "iunc-login.firebasestorage.app",
  messagingSenderId: "359473829379",
  appId: "1:359473829379:web:b1102278155f598e316036"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUID = null;
let allNotes = [];

const contentInput = document.getElementById("content");
const notesDiv = document.getElementById("notes");

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    currentUID = user.uid;
    listenUserNotes();
    listenOldNotes(); // hiển thị note cũ luôn
  }
});

window.logout = function(){
  signOut(auth).then(()=>window.location.href="login.html");
};

document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const text = contentInput.value.trim();
  if(!text) return;

  await addDoc(collection(db,"users",currentUID,"notes"),{
    text:text,
    createdAt:serverTimestamp()
  });

  contentInput.value="";
});

// nghe note mới (chuẩn)
function listenUserNotes(){
  onSnapshot(collection(db,"users",currentUID,"notes"),(snap)=>{
    snap.forEach(docSnap=>{
      const data=docSnap.data();
      renderNote(docSnap.id,data,true);
    });
  });
}

// nghe note cũ
function listenOldNotes(){
  onSnapshot(collection(db,"notes"),(snap)=>{
    snap.forEach(docSnap=>{
      const data=docSnap.data();
      renderNote(docSnap.id,data,false);
    });
  });
}

function renderNote(id,data,isNew){
  if(document.getElementById(id)) return;

  const div=document.createElement("div");
  div.className="note";
  div.id=id;

  const date=data.createdAt?.toDate?.().toLocaleString("vi-VN")||"";

  div.innerHTML=`
    <small>${isNew?"(Mới)":"(Cũ)"} ${date}</small>
    <div style="margin-top:5px">${data.text}</div>
    ${isNew?`<button onclick="deleteNote('${id}')">Xóa</button>`:""}
  `;

  notesDiv.prepend(div);
}

window.deleteNote=async function(id){
  await deleteDoc(doc(db,"users",currentUID,"notes",id));
  document.getElementById(id)?.remove();
};

// migrate 1 lần
window.migrateOldNotes=async function(){
  const oldSnap=await getDocs(collection(db,"notes"));

  for(const d of oldSnap.docs){
    await addDoc(collection(db,"users",currentUID,"notes"),d.data());
  }

  alert("Đã migrate xong! Reload trang.");
};
</script>

</body>
</html>
